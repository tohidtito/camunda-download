name: Build and Upload Directly to My Server

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Pull and Save Docker Images
        run: |
          echo "Pulling Camunda 8.7 images..."
          docker pull camunda/zeebe:8.7.0
          docker pull camunda/operate:8.7.0
          docker pull camunda/tasklist:8.7.0
          docker pull camunda/identity:8.7.0
          docker pull postgres:13
          docker pull opensearchproject/opensearch:2.6.0
          docker pull opensearchproject/opensearch-dashboards:2.6.0

          echo "Saving all images to camunda87-images.tar..."
          docker save \
            camunda/zeebe:8.7.0 \
            camunda/operate:8.7.0 \
            camunda/tasklist:8.7.0 \
            camunda/identity:8.7.0 \
            postgres:13 \
            opensearchproject/opensearch:2.6.0 \
            opensearchproject/opensearch-dashboards:2.6.0 \
            -o camunda87-images.tar

          echo "File created:"
          ls -lh camunda87-images.tar

      - name: Install sshpass
        run: |
          sudo apt update
          sudo apt install -y sshpass

      - name: Upload to My Server
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        run: |
          echo "Uploading camunda87-images.tar to root@${SERVER_IP}:/root/ ..."
          sshpass -p "$SERVER_PASSWORD" scp \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            camunda87-images.tar \
            root@"$SERVER_IP":/root/
          echo "âœ… Ø¢Ù¾Ù„ÙˆØ¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!"
          echo ""
          echo "ğŸ“Œ Ø¯Ø³ØªÙˆØ±Ø§Øª Ø¨Ø¹Ø¯ÛŒ Ø±ÙˆÛŒ Ø³Ø±ÙˆØ±Øª:"
          echo "   cd ~"
          echo "   docker load -i camunda87-images.tar"
          echo "   curl -LO https://raw.githubusercontent.com/camunda/camunda-platform/8.7/docker-compose/docker-compose.yaml"
          echo "   sudo sysctl -w vm.max_map_count=262144"
          echo "   docker compose up -d"
